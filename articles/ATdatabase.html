<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ATdatabase • ATdatabase</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="ATdatabase">
<meta property="og:description" content="ATdatabase">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ATdatabase</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/ATdatabase.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="ATdatabase_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>ATdatabase</h1>
            
      
      
      <div class="hidden name"><code>ATdatabase.Rmd</code></div>

    </div>

    
    
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="co">#&gt; Loading required package: dbplyr</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dbplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:dplyr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     ident, sql</span></span>
<span><span class="co">#&gt; Loading required package: IntervalSurgeon</span></span>
<span><span class="co">#&gt; Loading required package: glue</span></span>
<span><span class="co">#&gt; Loading required package: magrittr</span></span>
<span><span class="co">#&gt; Loading required package: jsonlite</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'jsonlite'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:IntervalSurgeon':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     flatten</span></span>
<span><span class="co">#&gt; Loading required package: lubridate</span></span>
<span><span class="co">#&gt; Loading required package: timechange</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'lubridate'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     date, intersect, setdiff, union</span></span></code></pre>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The ATDatabase package provides a caching database for the Analyse Together (AT) Tool. With this tool people can analyse the data from their own environmental sensor, like citizens science air quality sensors. The AT tool follows a modular design so that we can easily adapt the tool for different projects or different user groups. This effectively will result in one generic tool and some other versions, more catered towards specific usages.</p>
<p>Data from a single environmental sensor are usually send to data providers who store the data and make the data available using API’s or websites. Data exploration tools like the AT tool also combine data from several providers, for example sensor data from community portals, wheater data from meteorolical institutes and reference data from national monitoring networks. All these data can be accessed by API’s but collecting the data is often slow. So it helps to reuse data after it is downloaded from the API.</p>
<p>With this package you can create a database in which all the data from different sources can be downloaded and stored in a generalised way for applications like the AT tool. The database provides caching functions, so when data is downloaded it is immediatly available for other users (or even applications)</p>
<p>While the sensor data is stored using a generalised data model, the pacakge also provides in data base tables and methods to store any other (unstructured) data. For example, information about type of sensor of about the location can also stored using any format, as long it is usable within R.</p>
</div>
<div class="section level2">
<h2 id="creating-the-database">Creating the database<a class="anchor" aria-label="anchor" href="#creating-the-database"></a>
</h2>
<p>Before we can create the database, we first have to look at the database model.</p>
<div class="section level3">
<h3 id="database-model">database model<a class="anchor" aria-label="anchor" href="#database-model"></a>
</h3>
<p>The database model is based on the concept of mobile or static stations. Each station contains equipment or sensors which measure a certain parameter, and the values of these parameters change over time.</p>
<p>A station can be any assemblage of measuring equipment. For example it can be a huge and expensive reference air monitoring station, but it can also be a cheap hobyist ducktape assemblage of exotic electronics. Each station contains one or more sensors. Such sensor doesn’t have to be an air quality monitoring sensor, also meteorological sensors are possible. It can be anything that measures something, somewhere, at some moment in time.</p>
<p>The variation of the measured values can be aggregated. If the sensor measures a value each second, these values can be aggregated by reporting the average of these values over one hour. For example, air quality data is often reported as one hour averaged values, because this gives a more robust and consistent result compared to the strong varying real time data. It is up to the user to determine at which aggregation level the data is stored in the database, the minimum is one value each second.</p>
<p>While basic sensor information, like station name and position, and measurements are stored as structured data, meta data about the station or sensor (or project or region where they belong to) can be stored in any format, as unstructured data. For the storage of these meta data a NoSQL approach is used. In this approach meta data is stored as JSON documents.</p>
<p>The database uses four tables to store both measurements, caching information and meta data. These four tables are:</p>
<ul>
<li>Measurements</li>
<li>caching</li>
<li>location<br>
</li>
<li>meta</li>
</ul>
<p>In the next sections we will explain the information model of the database in detail.</p>
<div class="section level4">
<h4 id="measurements-table-and-timestamps">Measurements table and timestamps<a class="anchor" aria-label="anchor" href="#measurements-table-and-timestamps"></a>
</h4>
<p>The measurements table contains all the measurements</p>
<table class="table">
<thead><tr class="header">
<th>Table</th>
<th>fields</th>
<th>format</th>
<th>description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>measurements</td>
<td>id</td>
<td>INT</td>
<td>primary key</td>
</tr>
<tr class="even">
<td>.</td>
<td>station</td>
<td>TEXT</td>
<td>station id</td>
</tr>
<tr class="odd">
<td>.</td>
<td>parameter</td>
<td>TEXT</td>
<td>parameter / sensor</td>
</tr>
<tr class="even">
<td>.</td>
<td>value</td>
<td>REAL</td>
<td>measured value</td>
</tr>
<tr class="odd">
<td>.</td>
<td>aggregation</td>
<td>REAL</td>
<td>aggregation period in seconds</td>
</tr>
<tr class="even">
<td>.</td>
<td>timestamp</td>
<td>INT</td>
<td>date - time of observation</td>
</tr>
</tbody>
</table>
<p>The station id is the name of the station, it is stored as a string. Any name can be chosen. The parameter is the name of the measured parameter stored as string. Addition information about the parameter, like unit of sensor type, should be stored in the meta data.</p>
<p>The value, stored as ‘real’, is a numerical value of the measurement. The aggregation field gives the aggregation level in seconds on which the value is based on.</p>
<p>Please note that you can not store values from the same station with different aggregation levels. For example with air quality data, you either have to chose between real time data or one hour averages. If you want to use both, then collect the real time data and calculate the one hour averages yourself.</p>
<p>The timestamp is the date and time of the observation. This is stored in seconds! While odd at first to have these timestamps in seconds, it is very practical to determine which time ranges are present in the database and which time ranges should be added (this is what the caching part of this package does). Seconds are also used internally in the operating system, the ‘start of time’ (second 0) is the ‘UNIX epoch’: 01-01-1970 at 00:00 UTC. The way we record timestamps is for each table the same, so all timestamps in other tables are also in seconds.</p>
</div>
<div class="section level4">
<h4 id="location-table">Location table<a class="anchor" aria-label="anchor" href="#location-table"></a>
</h4>
<p>The location table contains basic information about the station, like name and position.</p>
<table class="table">
<thead><tr class="header">
<th>Table</th>
<th>fields</th>
<th>format</th>
<th>description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>location</td>
<td>id</td>
<td>INT</td>
<td>primary key</td>
</tr>
<tr class="even">
<td>.</td>
<td>station</td>
<td>TEXT</td>
<td>station id</td>
</tr>
<tr class="odd">
<td>.</td>
<td>lat, lon</td>
<td>REAL</td>
<td>latitude / longitude</td>
</tr>
<tr class="even">
<td>.</td>
<td>timestamp</td>
<td>INT</td>
<td>date - time of station info</td>
</tr>
</tbody>
</table>
<p>The station id is refered by the measurements table and contains the name of the station. The lat and lon fields contain the position in latitude and longitude of the station. While we asume that you store this position using the WGS84 coordinate system, any coordinate system can be used, even grid based systems, as long as you name the coordinates lat and lon.</p>
<p>The timestamp contains the date and time when the position of the station is recorded. Static stations have a single record in this table while mobile station can have multiple records. It is up to the user to combine station mobility with measurements.</p>
</div>
<div class="section level4">
<h4 id="caching-table">Caching table<a class="anchor" aria-label="anchor" href="#caching-table"></a>
</h4>
<p>In the caching table the time ranges for which information about a station is present in the database, is recorded.</p>
<table class="table">
<thead><tr class="header">
<th>Table</th>
<th>fields</th>
<th>format</th>
<th>description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>caching</td>
<td>id</td>
<td>INT</td>
<td>primary key</td>
</tr>
<tr class="even">
<td>.</td>
<td>station</td>
<td>TEXT</td>
<td>station id</td>
</tr>
<tr class="odd">
<td>.</td>
<td>start, end</td>
<td>INT</td>
<td>time range / timestamps</td>
</tr>
</tbody>
</table>
<p>Again, station is refered by the other tables. Start and end are the start and end of a time range for which measurements are available in the measurements table.</p>
</div>
<div class="section level4">
<h4 id="meta-table">Meta table<a class="anchor" aria-label="anchor" href="#meta-table"></a>
</h4>
<p>The meta table contains unstructured data about stations, sensors, or whatever the user likes to store.</p>
<table class="table">
<thead><tr class="header">
<th>Table</th>
<th>fields</th>
<th>format</th>
<th>description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>meta</td>
<td>id</td>
<td>INT</td>
<td>primary key</td>
</tr>
<tr class="even">
<td>.</td>
<td>type</td>
<td>TEXT</td>
<td>type</td>
</tr>
<tr class="odd">
<td>.</td>
<td>ref</td>
<td>TEXT</td>
<td>reference</td>
</tr>
<tr class="even">
<td>.</td>
<td>doc</td>
<td>TEXT</td>
<td>JSON doc</td>
</tr>
</tbody>
</table>
<p>The type field determines the type of the meta data. For example ‘station’ for station info or ‘project’ for project info. It is up to the user to define the type. The ref field is a reference. For example if the type is ‘station’ the ref field can contain a station id to refer to a station.</p>
<p>The doc field contains the meta data itself. The user can store vectors, lists or data.frames as meta data. Internally this meta data is converted to a JSON object and stored in the doc field. When the data is retrieved the user gets the data as R object (vector, list, etc).</p>
<p>Because meta data is stored as, e.g., a data.frame, it is easy to get all the data of a certain type returned as single data.frames. These data.frames can be combined, resulting in one large table. This table can then be used further within the model or application.</p>
<p>While this looks complicated, it is actually a very versatile way to store data as you will see in the examples further on in this vignette.</p>
</div>
</div>
<div class="section level3">
<h3 id="create-the-database">Create the database<a class="anchor" aria-label="anchor" href="#create-the-database"></a>
</h3>
<p>The current version of this packages uses SQLite as database backend. While we foresee that other database systems, like PostgreSQL, can be used, it is not tested yet.</p>
<p>To create a database we have to create an SQLite database, these databases are file based. For this vignette we create this database in the tempory R directory.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/pool" class="external-link">pool</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rsqlite.r-dbi.org" class="external-link">RSQLite</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ATdatabase</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fname_db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">dbconn</span> <span class="op">&lt;-</span> <span class="fu">pool</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pool/man/dbPool.html" class="external-link">dbPool</a></span><span class="op">(</span>drv <span class="op">=</span> <span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, dbname <span class="op">=</span> <span class="va">fname_db</span><span class="op">)</span></span></code></pre></div>
<p>After creating the database we have to create the database tables. We can use the <code>create_database_tables</code> for that. After the creation we check if the tables exists</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/create_database_tables.html">create_database_tables</a></span><span class="op">(</span><span class="va">dbconn</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="fu">pool</span><span class="fu">::</span><span class="fu">dbListTables</span><span class="op">(</span><span class="va">dbconn</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "cache"           "location"        "measurements"    "meta"           </span></span>
<span><span class="co">#&gt; [5] "sqlite_sequence"</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="downloading-and-storing-data">Downloading and storing data<a class="anchor" aria-label="anchor" href="#downloading-and-storing-data"></a>
</h2>
<p>Before you can download and store (cache) your downloaded data you have to make a few preparations. In general you have to create functions to get the data about stations, for the location info table. Also, you have to create a download function to obtain the station measurements. These functions have to return the data in a specifific format so they can be used in conjunction with the functions from this package. For each data provider, you have to write these functions since they will be specific for the data provider’s API.</p>
<p>This package contains example data and we simulate the download of data b reading this example data. It is not the real thing but i should give you understanding how this all works. The sample data is a single file with all the information in one single table.</p>
<p>We load the sample data and have a quick look</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">exdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"ex_data.rds"</span>, </span>
<span>                            package <span class="op">=</span> <span class="st">"ATdatabase"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">exdata</span><span class="op">)</span></span>
<span><span class="co">#&gt; tibble [11,670 × 6] (S3: tbl_df/tbl/data.frame)</span></span>
<span><span class="co">#&gt;  $ station  : chr [1:11670] "SSK_LH022" "SSK_LH022" "SSK_LH022" "SSK_LH022" ...</span></span>
<span><span class="co">#&gt;  $ parameter: chr [1:11670] "pres" "pres" "pres" "pres" ...</span></span>
<span><span class="co">#&gt;  $ value    : num [1:11670] 1024 1023 1023 1023 1023 ...</span></span>
<span><span class="co">#&gt;  $ timestamp: int [1:11670] 1643673600 1643677200 1643680800 1643684400 1643688000 1643691600 1643695200 1643698800 1643702400 1643706000 ...</span></span>
<span><span class="co">#&gt;  $ lat      : num [1:11670] 51.5 51.5 51.5 51.5 51.5 ...</span></span>
<span><span class="co">#&gt;  $ lon      : num [1:11670] 3.96 3.96 3.96 3.96 3.96 ...</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">exdata</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    station           parameter             value            timestamp        </span></span>
<span><span class="co">#&gt;  Length:11670       Length:11670       Min.   :-999.000   Min.   :1.644e+09  </span></span>
<span><span class="co">#&gt;  Class :character   Class :character   1st Qu.:   8.145   1st Qu.:1.644e+09  </span></span>
<span><span class="co">#&gt;  Mode  :character   Mode  :character   Median :  13.620   Median :1.644e+09  </span></span>
<span><span class="co">#&gt;                                        Mean   : 147.755   Mean   :1.644e+09  </span></span>
<span><span class="co">#&gt;                                        3rd Qu.:  62.260   3rd Qu.:1.644e+09  </span></span>
<span><span class="co">#&gt;                                        Max.   :1028.000   Max.   :1.644e+09  </span></span>
<span><span class="co">#&gt;                                        NA's   :587                           </span></span>
<span><span class="co">#&gt;       lat             lon       </span></span>
<span><span class="co">#&gt;  Min.   :51.48   Min.   :3.959  </span></span>
<span><span class="co">#&gt;  1st Qu.:51.89   1st Qu.:4.355  </span></span>
<span><span class="co">#&gt;  Median :51.92   Median :4.460  </span></span>
<span><span class="co">#&gt;  Mean   :51.88   Mean   :4.380  </span></span>
<span><span class="co">#&gt;  3rd Qu.:51.94   3rd Qu.:4.488  </span></span>
<span><span class="co">#&gt;  Max.   :51.98   Max.   :4.503  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="va">exdata</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 11,670 × 6</span></span></span>
<span><span class="co">#&gt;    station   parameter value  timestamp   lat   lon</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>024  <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">673</span>600  51.5  3.96</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>023. <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">677</span>200  51.5  3.96</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>023. <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">680</span>800  51.5  3.96</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>023  <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">684</span>400  51.5  3.96</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>023. <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">688</span>000  51.5  3.96</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>022. <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">691</span>600  51.5  3.96</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>021. <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">695</span>200  51.5  3.96</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>020  <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">698</span>800  51.5  3.96</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>019. <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">702</span>400  51.5  3.96</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>019. <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">706</span>000  51.5  3.96</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 11,660 more rows</span></span></span></code></pre></div>
<div class="section level3">
<h3 id="downloading-and-storing-sensor-info">Downloading and storing sensor info<a class="anchor" aria-label="anchor" href="#downloading-and-storing-sensor-info"></a>
</h3>
<p>Information about station are divided over two database tables. The location table only contains the station identifier, the coordinates (lat, lon) and a timestamp. All other station data is stored in the meta table as unstructured data.</p>
<p>To get the generalised data from a station (identifier, lat, lon) we first create a download function which does all the API calls. In our example this is just a simple select from the example data. The download function must return a data.frame with three fields: ‘station’, ‘lat’, and ‘lon’. The station field is the station identifier (a string), the lat and lon fields are the coordinates (as numeric values).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">ex_download_station_info</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span> <span class="op">=</span> <span class="va">exdata</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">res</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">station</span>, <span class="va">lat</span>, <span class="va">lon</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">stat_info</span> <span class="op">&lt;-</span> <span class="fu">ex_download_station_info</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">stat_info</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 3</span></span></span>
<span><span class="co">#&gt;    station     lat   lon</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> SSK_LH022  51.5  3.96</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> SSK_LD017  51.9  4.49</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> SSK_LD016  51.9  4.36</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> SSK_LD015  51.9  4.48</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> SSK_LD014  51.9  4.46</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> SSK_LD013  51.9  4.48</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> SSK_LD012  51.9  4.44</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> SSK_LD011  51.9  4.50</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> SSK_LD010  52.0  4.14</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> SSK_LD009  52.0  4.50</span></span></code></pre></div>
<p>The station info can then be stored in the database. You only can store one station at a time. So if you have a data frame with station info as above, then you have to use either a for loop of an apply function. In the follwoing example we get the station information and use a vectorized function to store the data into the database using the <code>insert_location_info</code> function from the package.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">insert_location_info_vectorized</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">conn</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/insert_location_info.html">insert_location_info</a></span><span class="op">(</span>station <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                        lat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                        lon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                        <span class="va">conn</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">stat_info</span>, <span class="fl">1</span>, FUN  <span class="op">=</span> <span class="va">insert_location_info_vectorized</span>, </span>
<span>      conn <span class="op">=</span> <span class="va">dbconn</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 1 1 1 1 1 1 1 1 1 1</span></span></code></pre></div>
<p>Now check how our location table looks like.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">dbconn</span>, <span class="st">"location"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">s</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 5</span></span></span>
<span><span class="co">#&gt;      id station     lat   lon   timestamp</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1 SSK_LH022  51.5  3.96 <span style="text-decoration: underline;">1</span>669<span style="text-decoration: underline;">203</span>366.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     2 SSK_LD017  51.9  4.49 <span style="text-decoration: underline;">1</span>669<span style="text-decoration: underline;">203</span>366.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     3 SSK_LD016  51.9  4.36 <span style="text-decoration: underline;">1</span>669<span style="text-decoration: underline;">203</span>366.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     4 SSK_LD015  51.9  4.48 <span style="text-decoration: underline;">1</span>669<span style="text-decoration: underline;">203</span>366.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     5 SSK_LD014  51.9  4.46 <span style="text-decoration: underline;">1</span>669<span style="text-decoration: underline;">203</span>366.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>     6 SSK_LD013  51.9  4.48 <span style="text-decoration: underline;">1</span>669<span style="text-decoration: underline;">203</span>366.</span></span></code></pre></div>
<p>As you probably allready noticed, we didn’t provide a timestamp. The insert_location_info function adds the current timestamp to the record if no timestamp is given.</p>
<div class="section level4">
<h4 id="adding-meta-data">Adding meta data<a class="anchor" aria-label="anchor" href="#adding-meta-data"></a>
</h4>
<p>Meta data can be stored in the database using the <code>add_doc</code> function. Meta data can be any R object and is internally stored as JSON document. Each meta data object must be given a type and reference value. For example meta data about a station can be of type ‘station’ while meta data about a sensor cab be of type ‘sensor’. The reference is a reference to, for example, the station id or the sensor type. As user you can define any scheme of type and reference as you like.</p>
<p>The meta data object is just an R object, like a list, data.frame, or vector. From our example dataset we have for each station a comma seperated list of the measured parameters.</p>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 2</span></span></span>
<span><span class="co">#&gt;    station   pars                                        </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> SSK_LD009 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> SSK_LD010 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> SSK_LD011 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> SSK_LD012 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> SSK_LD013 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> SSK_LD014 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> SSK_LD015 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> SSK_LD016 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> SSK_LD017 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> SSK_LH022 pres,rh,temp,no2,pm10_kal,pm10,pm25_kal,pm25</span></span></code></pre>
<p>As an example we create a meta data object containing the measured parameters for each station. We can store this list of parameters as meta data, using ‘parameters’ as type and the station id as reference</p>
<p>The meta data looks like:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">meta</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 2</span></span></span>
<span><span class="co">#&gt;    station   pars                                        </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> SSK_LD009 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> SSK_LD010 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> SSK_LD011 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> SSK_LD012 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> SSK_LD013 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> SSK_LD014 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> SSK_LD015 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> SSK_LD016 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> SSK_LD017 pm10_kal,pm10,pres,rh,temp,no2,pm25_kal,pm25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> SSK_LH022 pres,rh,temp,no2,pm10_kal,pm10,pm25_kal,pm25</span></span></code></pre></div>
<p>Then we store a single object</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">statname</span> <span class="op">&lt;-</span> <span class="va">meta</span><span class="op">$</span><span class="va">station</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">statpars</span> <span class="op">&lt;-</span> <span class="va">meta</span><span class="op">$</span><span class="va">pars</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="../reference/add_doc.html">add_doc</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"parameter"</span>,</span>
<span>        ref <span class="op">=</span> <span class="va">statname</span>,</span>
<span>        doc <span class="op">=</span> <span class="va">statpars</span>,</span>
<span>        conn <span class="op">=</span> <span class="va">dbconn</span></span>
<span>        <span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span></code></pre></div>
<p>And then we get the some object from the database. This document is identical to the object we stored in the database.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">doc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_doc.html">get_doc</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"parameter"</span>, ref <span class="op">=</span> <span class="va">statname</span>, conn <span class="op">=</span> <span class="va">dbconn</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">statpars</span>, <span class="va">doc</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>To add multiple meta data objects you can use an for loop or an apply function, and call add_doc repeatedly</p>
</div>
<div class="section level4">
<h4 id="adding-information-about-stations">Adding information about stations<a class="anchor" aria-label="anchor" href="#adding-information-about-stations"></a>
</h4>
<p>One of the things you probably need is a list of stations, grouped by municpality, region, or project. This list of stations can be used as selection criteria to get, for example, locations to draw on a map. This list can also be used if you want to download a dataset for a complete project or region.</p>
<p>This list of station can be stored as meta data to retreive when necessary. In our case we store the list of stations as a simple vector. Further on in this vignette we use this list to get the measured data. We store the meta data using ‘station’ as type and ‘example’ as reference (in this case a project name).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">stations</span> <span class="op">&lt;-</span> <span class="va">meta</span><span class="op">$</span><span class="va">station</span></span>
<span><span class="va">stations</span></span>
<span><span class="co">#&gt;  [1] "SSK_LD009" "SSK_LD010" "SSK_LD011" "SSK_LD012" "SSK_LD013" "SSK_LD014"</span></span>
<span><span class="co">#&gt;  [7] "SSK_LD015" "SSK_LD016" "SSK_LD017" "SSK_LH022"</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="../reference/add_doc.html">add_doc</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"stations"</span>,</span>
<span>        ref <span class="op">=</span> <span class="st">"example"</span>,</span>
<span>        doc <span class="op">=</span> <span class="va">stations</span>,</span>
<span>        conn <span class="op">=</span> <span class="va">dbconn</span></span>
<span>        <span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="downloading-and-storing-measurements">Downloading and storing measurements<a class="anchor" aria-label="anchor" href="#downloading-and-storing-measurements"></a>
</h2>
<p>Since the ATdatabase is a caching database, it is assumed that there is an original dataasource. Most often this datasource is a database or a web API. To add measurements to the database, the data must first be downloaded before it can be stored.</p>
<p>Since each data source has its own interface to request and deliver data, it is not possible to create a single ‘fit for all’ download function. So the download proces is split in two. First, the user must write a download function, the download handler. Then second this download handler must be provided to a generic download function wich calls the handler, proces the data and store them to the database.</p>
<p>The generic download functions (<code>download_data</code>) takes the staion id, the time range to download, the name of the download handler function, and the database object as arguments. When this function is called it checks which time ranges are allready downloaded for that station and which time ranges are lacking. This means that as an user you ask a single time range, but that internally you have to download multiple smaller time ranges. For each time range that must be downloaded, the download handler is called.</p>
<p>The download handler takes the station id and a single time range and translates this into an database or API call. It doesn’t matter how you write the download handler as long as you keep to the following prerequisits:</p>
<ol style="list-style-type: decimal">
<li>The arguments of the function must be timerange, station, and database connection</li>
<li>The return of the function is a data.frame with measurements</li>
</ol>
<p>Let’s start with the arguments of the function. The timeranges is a matrix with a single row and two columns. The first column is the start time in seconds (POSIX time) and the second column in the end time in seconds. Using the <code>datetime_to_matrix</code> function you can translate ordinary dates into this matrix.</p>
<p>The station id is the reference to a station, this id depends on the data source. The station ids in the database are thus the same ids as in the datasource.</p>
<p>The conn argument is the database conenction object. This is needed if you want to get, for example, meta data from the database. E.g. the names of the parameters to download.</p>
<p>For each download operation it is up to you which parameters to download. This parameter selection is part of the download handler. The easiest way is to always download the same selection from each data source. Think carefully about which parameters you selected. It is not possible to change this after you have downloaded the data, unless you clear the database and start al over.</p>
<p>The return of the function must return a data.frame with at least the following fields:</p>
<ol style="list-style-type: decimal">
<li>
<em>station:</em> the station id</li>
<li>
<em>parameter</em>: the measured parameter</li>
<li>
<em>value</em>: the measured value</li>
<li>_timestamp_the timestamp of the measurements, in seconds (!)<br>
</li>
<li>
<em>aggregation</em> aggregation level (in seconds!)</li>
</ol>
<p>If the returning data.frame contains more field, then they are simply ignored when storing the data into the measurement table. The time stamp must be given in seconds (POSIXct format). The aggregation is also in seconds, so for one hour averaged measurements this is 3600.</p>
<div class="section level3">
<h3 id="download-handler">Download handler<a class="anchor" aria-label="anchor" href="#download-handler"></a>
</h3>
<p>For the sake of simplicity, for this vignette we use a file with measurements instead of an database or API. Our download handler thus reads from file instead from a remote.</p>
<p>Our download handler looks like this:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">download_data_fun</span></span>
<span><span class="co">#&gt; function (x, station, conn) </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     db_ex &lt;- system.file("extdata", "ex_data.rds", package = "ATdatabase")</span></span>
<span><span class="co">#&gt;     d &lt;- readRDS(db_ex)</span></span>
<span><span class="co">#&gt;     s_id &lt;- station</span></span>
<span><span class="co">#&gt;     res &lt;- d %&gt;% dplyr::filter(station == s_id) %&gt;% dplyr::filter(timestamp &gt; </span></span>
<span><span class="co">#&gt;         x[1] &amp; timestamp &lt;= x[2]) %&gt;% dplyr::select(-lat, lon) %&gt;% </span></span>
<span><span class="co">#&gt;         dplyr::mutate(aggregation = 3600)</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x564cb2909368&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:ATdatabase&gt;</span></span></code></pre></div>
<p>Just as example, we call this function directly to show the input arguments and output. For station SSK_LH022 we wil get the data for the time range 2022-02-01 to 2022-02-07 23:00:00. The download_data_fun requires that we provide this timerange as matrix, with time in seconds. We use the <code>datetime_to_matrix</code> function to convert our timestamps</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">statname</span></span>
<span><span class="co">#&gt; [1] "SSK_LH022"</span></span>
<span><span class="va">start_date</span></span>
<span><span class="co">#&gt; [1] "2022-02-01 UTC"</span></span>
<span><span class="va">end_date</span></span>
<span><span class="co">#&gt; [1] "2022-02-07 23:00:00 UTC"</span></span>
<span></span>
<span><span class="va">time_stamp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/datetime_to_matrix.html">datetime_to_matrix</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="va">end_date</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_data_fun.html">download_data_fun</a></span><span class="op">(</span><span class="va">time_stamp</span>, <span class="va">statname</span>, <span class="va">dbconn</span><span class="op">)</span></span>
<span><span class="va">x</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1,161 × 6</span></span></span>
<span><span class="co">#&gt;    station   parameter value  timestamp   lon aggregation</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>023. <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">677</span>200  3.96        <span style="text-decoration: underline;">3</span>600</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>023. <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">680</span>800  3.96        <span style="text-decoration: underline;">3</span>600</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>023  <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">684</span>400  3.96        <span style="text-decoration: underline;">3</span>600</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>023. <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">688</span>000  3.96        <span style="text-decoration: underline;">3</span>600</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>022. <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">691</span>600  3.96        <span style="text-decoration: underline;">3</span>600</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>021. <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">695</span>200  3.96        <span style="text-decoration: underline;">3</span>600</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>020  <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">698</span>800  3.96        <span style="text-decoration: underline;">3</span>600</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>019. <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">702</span>400  3.96        <span style="text-decoration: underline;">3</span>600</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>019. <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">706</span>000  3.96        <span style="text-decoration: underline;">3</span>600</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> SSK_LH022 pres      <span style="text-decoration: underline;">1</span>018  <span style="text-decoration: underline;">1</span>643<span style="text-decoration: underline;">709</span>600  3.96        <span style="text-decoration: underline;">3</span>600</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 1,151 more rows</span></span></span></code></pre></div>
<p>Off course you don’t want to just download the data, but also store the measurements and update the available time ranges. This is done in the <code>download_data</code> function.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_data.html">download_data</a></span><span class="op">(</span>station <span class="op">=</span> <span class="va">statname</span>, Tstart <span class="op">=</span> <span class="va">start_date</span>,</span>
<span>              Tend <span class="op">=</span> <span class="va">end_date</span>, </span>
<span>              fun <span class="op">=</span> <span class="va">download_data_fun</span>, conn <span class="op">=</span> <span class="va">dbconn</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: &lt;Pool&gt; uses an old dbplyr interface</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">ℹ</span> Please install a newer version of the package or contact the maintainer</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span></code></pre></div>
<p>The download data function returns the retreived data as result. It is up to the user to do something with it, but the data is allready stored thus it can be ignored.</p>
</div>
<div class="section level3">
<h3 id="getting-data-from-multiple-stations">Getting data from multiple stations<a class="anchor" aria-label="anchor" href="#getting-data-from-multiple-stations"></a>
</h3>
<p>The download_data function only gets data from a single station. To get multiple stations you can use a for loop or an apply function. In this example we get all the measurements for each station and store them in the database.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">stations_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_doc.html">get_doc</a></span><span class="op">(</span><span class="st">"stations"</span>, <span class="st">"example"</span>, conn <span class="op">=</span> <span class="va">dbconn</span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">stations_list</span>,  FUN <span class="op">=</span> <span class="va">download_data</span>, Tstart <span class="op">=</span> <span class="va">start_date</span>,</span>
<span>      Tend <span class="op">=</span> <span class="va">end_date</span>, fun <span class="op">=</span> <span class="va">download_data_fun</span>, conn <span class="op">=</span> <span class="va">dbconn</span><span class="op">)</span></span></code></pre></div>
<p>The result variable contains a list with all the downloaded datasets. However, since all the data is allready stored we can simply ignore the result.</p>
</div>
</div>
<div class="section level2">
<h2 id="using-the-data">Using the data<a class="anchor" aria-label="anchor" href="#using-the-data"></a>
</h2>
<p>If you want to use the location info or the measurements from the database, you can select them directly. It is easy to create a such selection of data using dplyr functions. For example to select all the measurements for station SSK_LH022:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">dbconn</span>, <span class="st">"measurements"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">station</span> <span class="op">==</span> <span class="va">statname</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="va">value</span>, <span class="va">timestamp</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>timestamp  <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html" class="external-link">as_datetime</a></span><span class="op">(</span><span class="va">timestamp</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">result</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1,161 × 3</span></span></span>
<span><span class="co">#&gt;    parameter   value timestamp          </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>             </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> pres      <span style="text-decoration: underline;">1</span>023.   2022-02-01 <span style="color: #949494;">01:00:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> rh          71.6  2022-02-01 <span style="color: #949494;">01:00:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> temp         5.38 2022-02-01 <span style="color: #949494;">01:00:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> no2          2.12 2022-02-01 <span style="color: #949494;">01:00:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> pm10_kal    18.3  2022-02-01 <span style="color: #949494;">01:00:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> pm10        21    2022-02-01 <span style="color: #949494;">01:00:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> pm25_kal     6.13 2022-02-01 <span style="color: #949494;">01:00:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> pm25         6.13 2022-02-01 <span style="color: #949494;">01:00:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> pres      <span style="text-decoration: underline;">1</span>023.   2022-02-01 <span style="color: #949494;">02:00:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> rh          72.9  2022-02-01 <span style="color: #949494;">02:00:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 1,151 more rows</span></span></span></code></pre></div>
<p>Please not that you have to ‘collect’ the data, otherwise the result will be a ‘lazy query’ instead of a tibble. This lazy query is evaluated when the object is used, but this evaluation does not happen always, giving funky results. A drawback of the collect function is that this ‘freezes’ the data, if the data is updated in the database, your ‘result’ object won’t be updated (but is does get updated if it’s a lazy query, since the query is executed when you call the object).</p>
<p>If you use mutate functions, then it is best to do them after the collect function.</p>
<p>If you want to get location data, you can also use dplyr functions, for example:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">dbconn</span>, <span class="st">"location"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">station</span> <span class="op">==</span> <span class="va">statname</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">lat</span>,<span class="va">lon</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">result</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 2</span></span></span>
<span><span class="co">#&gt;     lat   lon</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  51.5  3.96</span></span></code></pre></div>
<p>If you want to get meta data from the database, then use the get_doc function. A few examples of this function are shown above.</p>
<p>Stay away from the cache table. Let the package handle this table</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Job Spijker.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
